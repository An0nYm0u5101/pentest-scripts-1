#!/bin/bash

# Horizontal Domain Correlation

# Find all possibles domains

html2text_bin=$(command -v html2text)
domain_main="$1"
emails=($(whois ${domain_main} | grep -E "Registrant Email|^e-mail" | egrep -ho "[[:graph:]]+@[[:graph:]]+"))
curl_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.85 Safari/537.36"
domains_horizontal=()

tput setaf 4; echo "Finding domains..."
tput setaf 7;

for email in "${emails[@]}"; do
    domains_found=($(curl -s -A "${curl_agent}" "https://viewdns.info/reversewhois/?q=$email" | \
        "${html2text_bin}" | \
        grep -Po "[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)" | \
        grep -Evi "viewdns|${email}"))
    [[ ${#domains_found[@]} -gt 0 ]] && domains_horizontal+=("${domains_found[@]}")
done

if [ ${#domains_horizontal[@]} -gt 0 ]; then
    printf "%s\n" "${domains_horizontal[@]}"
else
    echo "No domain found, exiting!"
    exit 1
fi

# Finding valid domain (that have valid A record).
# After that domains without A record will be rechecked$

tput setaf 4; echo "Domains validation (DNS requests)..."

for d in ${domains_horizontal[@]}; do
    if [[ $(dig "${d}" +short +time=5 +tries=1 @8.8.8.8 | wc -c) -eq 0 ]]; then
        tput setaf 1;  echo -n "Invalid domain: "
        tput setaf 7; echo "${d}"
    else
        tput setaf 3; echo -n "Valid domain: "
        tput setaf 7; echo "${d}"
    fi
done
