#############################################################
#                                                           #
# This file is an essential part of collector's execution!  #
# And is responsible to get the functions:                  #
#   * diff_domains                                          #
#                                                           #
############################################################# 

diff_domains(){
    if [ -d "${report_dir}" ]; then 
        if [ -s "${report_dir}/domains_alive.txt" ]; then
            oldest_domains_alive=$(find "${output_dir}/${domain}" -name domains_alive.txt -type f | sort -u | grep -v "${date_recon}" | tail -n1)
            oldest_domains_web=$(find "${output_dir}/${domain}" -name domains_web.txt -type f | sort -u | grep -v "${date_recon}" | tail -n1)
            if [[ -n "${oldest_domains_alive}" ]] && [[ -n "${oldest_domains_web}" ]]; then
                if cmp -s "${oldest_domains_alive}" "${report_dir}/domains_alive.txt"; then
                    echo -ne "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} Getting the difference between files to improve the time running collector script... "
                    diff -au "${oldest_domains_alive}" "${report_dir}/domains_alive.txt" | grep -E '^\+' | sed -e '/+++/d' -e 's/^+//' >> "${report_dir}/domains_diff.txt"
                    if [ -s "${report_dir}/domains_diff.txt" ]; then
                        if mv "${report_dir}/domains_alive.txt" "${report_dir}/domains_found.${date_recon}"; then
                            cp "${report_dir}/domains_diff.txt" "${report_dir}/domains_alive.txt"
                        else
                            echo " "
                            echo -e "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} Error during move domains_alive.txt to domains_found.old."
                            echo -e "\t Stopping the script!"
                            exit 1
                        fi
                    else
                        echo " "
                        echo -e "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} There isn't any changes since last execution."
                        echo -e "\t Stopping the script!"
                        exit 1
                    fi
                    echo "Done!"
                else
                    echo -e "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} The files are same since last execution of collector!"
                    echo -e "\t Stopping the script!"
                    exit 1
                fi
            else
                echo -e "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} There is nothing different between, this execution and the last one!"
            fi
            unset data
        else
            echo -e "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} diff_domains function error: file ${report_dir}/domains_alive.txt does not exist or is empty!"
            exit 1
        fi
    else
        echo -e "${yellow}$(date +%H:%M)${reset} ${red}>>${reset} Make sure the directories structure was created. Stopping the script."
        exit 1
    fi
}
