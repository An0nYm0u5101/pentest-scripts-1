#!/bin/bash

network="$(echo $1 | awk -F'/' '{print $1}')"
cidr="$(echo $1 | awk -F'/' '{print $2}')"
result_dir="$2"
result_file="${result_dir}/nmap_result.txt"
ips_file=/tmp/ips.txt
IPv4_regex='^((25[0-5]|2[0-4][0-9]|[01][0-9][0-9]|[0-9]{1,2})[.]){3}(25[0-5]|2[0-4][0-9]|[01][0-9][0-9]|[0-9]{1,2})$'

if [ -z $(command -v html2text) ]; then 
    echo -e "Please, install html2text with:"
    echo "    pip install html2text"
    exit 1
fi

if [ -z "${network}" ] || [ -z "${cidr}" ] || [ -z "${result_dir}" ]; then
    echo "You need to inform the first argument as network designation."
    echo "The second you need to inform a valid directory to save the result from nmap."
    exit 1
fi

if [[ ! ${network} =~ ${IPv4_regex} ]]; then
    echo "Please, the first argument must be a valid IP address."
    exit 1
fi

if [ ${cidr} -gt 32 ] || [ ${cidr} -le 0 ] ; then
    echo "Please, the cidr must be a number between 1 and 32."
    exit 1
fi

if [ ! -d "${result_dir}" ]; then
    echo "Please, inform a valid directory."
    exit 1
fi

if [ -s "${ips_file}" ] && [ -s "${result_file}" ]; then
    echo "Resuming... "
    for ip in $(cat "${ips_file}"); do
        echo "nmap -n -Pn --top-ports 1000 --max-retries 3 --host-timeout 10s ${ip} >> ${result_file}"
        nmap -n -Pn --top-ports 1000 --max-retries 3 --host-timeout 10s "${ip}" >> "${result_file}"
        sed -i "/${ip}/d" "${ips_file}"
    done
fi

network_result="$(curl -s "http://jodies.de/ipcalc?host=${network}&mask1=${cidr}" | \
    html2text | sed "s/^[[:blank:]]*//g" | \
    grep -E "^Address|^Netmask|^Wildcard|^=>|^Network|^Broadcast|^HostMin|^HostMax|^Hosts/Net"
)"

if [ ${cidr} -eq 32 ]; then
    host_min=$(echo "${network_result}" | grep -E "^HostMin:" | awk '{print $2}')
    host_max=$(echo "${network_result}" | grep -E "^HostMax:" | awk '{print $2}')
    if [ "${host_min}" == "${host_max}" ]; then
        echo "${host_max}" >> "${ips_file}"
    fi
elif [ ${cidr} -eq 24 ]; then
    network_octets=$(echo "${network_result}" | grep -E "^Network:" | awk '{print $2}' | cut --output-delimiter='.' -d'.' -f 1-3)
    host_count=$(echo "${network_result}" | grep -E "^HostMin:" | awk -F'.' '{print $4}' | cut -d' ' -f1)
    host_final=$(echo "${network_result}" | grep -E "^HostMax:" | awk '{print $2}')
    while [[ "${ip}" != "${host_final}" ]] ; do
        ip="${network_octets}.${host_count}"
        (( host_count += 1 ))
        echo "${ip}" >> "${ips_file}"
    done
else
    network_initial=$(echo "${network_result}" | grep -E "^HostMin:" | awk -F'.' '{print $3}')
    network_final=$(echo "${network_result}" | grep -E "^HostMax:" | awk -F'.' '{print $3}')
    network_octets=$(echo "${network_result}" | grep -E "^Network:" | awk '{print $2}' | cut --output-delimiter='.' -d'.' -f 1-2)
    network_count=${network_initial}
    host_count=$(echo "${network_result}" | grep -E "^HostMin:" | awk -F'.' '{print $4}' | cut -d' ' -f1)
    host_final=$(echo "${network_result}" | grep -E "^HostMax:" | awk '{print $2}')
    while [[ "${ip}" != "${host_final}" ]] ; do
        ip="${network_octets}.${network_count}.${host_count}"
        (( host_count += 1 ))
        if [ ${host_count} -gt 255 ]; then
            host_count=0
            [[ ${network_count} -lt ${network_final} ]] && (( network_count += 1 ))
        fi
        echo "${ip}" >> "${ips_file}"
    done
fi

unset ip

if [ -s "${ips_file}" ]; then
    for ip in $(cat "${ips_file}"); do
        echo "nmap -n -Pn --top-ports 1000 --max-retries 3 --host-timeout 10s ${ip} >> ${result_file}"
        nmap -n -Pn --top-ports 1000 --max-retries 3 --host-timeout 10s "${ip}" >> "${result_file}"
        sed -i "/${ip}/d" "${ips_file}"
    done
    rm -rf "${ips_file}"
fi
